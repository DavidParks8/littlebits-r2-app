<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:LittleBitsR2Controller.ViewModels"
             xmlns:views="clr-namespace:LittleBitsR2Controller.Views"
             x:Class="LittleBitsR2Controller.Views.ControllerPage"
             x:DataType="viewmodels:ControllerViewModel"
             Title="R2-D2 Controller"
             BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceLight}, Dark={StaticResource Surface}}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <x:Boolean x:Key="True">True</x:Boolean>
            <x:Boolean x:Key="False">False</x:Boolean>
            <Style x:Key="SoundButtonStyle" TargetType="Button">
                <Setter Property="Margin" Value="3"/>
                <Setter Property="Padding" Value="10,6"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="CornerRadius" Value="14"/>
                <Setter Property="MinimumWidthRequest" Value="70"/>
                <Setter Property="HeightRequest" Value="34"/>
                <Setter Property="MinimumHeightRequest" Value="34"/>
                <Setter Property="VisualStateManager.VisualStateGroups">
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource Primary}}"/>
                                    <Setter Property="TextColor" Value="White"/>
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="PointerOver">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource Primary}}"/>
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="Pressed">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource Primary}}"/>
                                    <Setter Property="Opacity" Value="0.8"/>
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="Disabled">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#B0BEC5, Dark=#455A64}"/>
                                    <Setter Property="TextColor" Value="{AppThemeBinding Light=#78909C, Dark=#90A4AE}"/>
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </Setter>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- Top bar: status + connection -->
        <Border Grid.Row="0"
                BackgroundColor="{AppThemeBinding Light={StaticResource CardLight}, Dark={StaticResource CardDark}}"
                Stroke="Transparent"
                Padding="16,10">
            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="6">

                <!-- Status chip -->
                <Border Grid.Row="0" Grid.Column="0"
                        BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B3A1B}"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 12"
                        Padding="12,6"
                        HorizontalOptions="Start"
                        IsVisible="{Binding IsConnected}">
                    <Label Text="{Binding StatusMessage}" 
                           FontSize="13" 
                           TextColor="{AppThemeBinding Light={StaticResource Success}, Dark={StaticResource SuccessDark}}"
                           FontAttributes="Bold"/>
                </Border>

                <Label Grid.Row="0" Grid.Column="0"
                       Text="{Binding StatusMessage}" 
                       FontSize="13" 
                       TextColor="{StaticResource Gray500}"
                       VerticalOptions="Center"
                       IsVisible="{Binding IsConnected, Converter={StaticResource InvertedBoolConverter}}"/>

                <!-- Connection actions (top-right) -->
                <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="8" VerticalOptions="Center">
                    <Button Text="Scan" 
                            Command="{Binding ScanForDevicesCommand}"
                            IsEnabled="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}"
                            IsVisible="{Binding IsConnected, Converter={StaticResource InvertedBoolConverter}}"
                            FontSize="12"
                            Padding="12,6"
                            HeightRequest="34"
                            MinimumHeightRequest="34"/>
                    <Button Text="Connect" 
                            Command="{Binding ConnectCommand}"
                            IsVisible="{Binding ShowDeviceSelector}"
                            IsEnabled="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}"
                            FontSize="12"
                            Padding="12,6"
                            HeightRequest="34"
                            MinimumHeightRequest="34"/>
                    <Button Text="Disconnect" 
                            Command="{Binding DisconnectCommand}"
                            IsVisible="{Binding IsConnected}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray600}}"
                            FontSize="12"
                            Padding="12,6"
                            HeightRequest="34"
                            MinimumHeightRequest="34"/>
                </HorizontalStackLayout>

                <!-- Device picker row (only when multiple devices found) -->
                <Grid Grid.Row="1" Grid.ColumnSpan="2" 
                      IsVisible="{Binding ShowDeviceSelector}"
                      ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Picker Title="Select R2-D2 Device"
                            ItemsSource="{Binding Devices}"
                            ItemDisplayBinding="{Binding Name}"
                            SelectedItem="{Binding SelectedDevice}"
                            IsEnabled="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}"/>
                    <ActivityIndicator Grid.Column="1" 
                                       IsRunning="{Binding IsScanning}" 
                                       IsVisible="{Binding IsScanning}"
                                       Color="{StaticResource Primary}"
                                       HeightRequest="24" WidthRequest="24"/>
                </Grid>
            </Grid>
        </Border>

        <!-- Main scrollable content -->
        <ScrollView Grid.Row="1" Padding="16,8">
            <VerticalStackLayout Spacing="12">

                <!-- ═══ JOYSTICK ═══ -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource CardLight}, Dark={StaticResource CardDark}}"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 16"
                        Padding="20,16"
                        InputTransparent="False">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Drive" FontSize="14" FontAttributes="Bold" 
                               TextColor="{StaticResource Gray500}" 
                               CharacterSpacing="1.5">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsConnected}" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                        <Label Text="Drag to drive · Release to stop" 
                               FontSize="12" 
                               TextColor="{StaticResource Gray400}" 
                               HorizontalOptions="Center">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsConnected}" Value="False">
                                    <Setter Property="Text" Value="Connect to a device to drive"/>
                                    <Setter Property="Opacity" Value="0.5"/>
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>

                        <views:JoystickView 
                            HeightRequest="260" 
                            WidthRequest="260"
                            HorizontalOptions="Center"
                            Margin="0,4"
                            IsEnabled="{Binding IsConnected}"
                            SemanticProperties.Description="Drive joystick"
                            SemanticProperties.Hint="Drag to control R2-D2 movement, release to stop"
                            MovedCommand="{Binding JoystickMovedCommand}"
                            ReleasedCommand="{Binding JoystickReleasedCommand}"/>
                    </VerticalStackLayout>
                </Border>

                <!-- ═══ SOUND EFFECTS ═══ -->
                <Border BackgroundColor="{AppThemeBinding Light={StaticResource CardLight}, Dark={StaticResource CardDark}}"
                        Stroke="Transparent"
                        StrokeShape="RoundRectangle 16"
                        Padding="20,16"
                        InputTransparent="False">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Sounds" FontSize="14" FontAttributes="Bold" 
                               TextColor="{StaticResource Gray500}" 
                               CharacterSpacing="1.5">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding IsConnected}" Value="False">
                                    <Setter Property="Opacity" Value="0.5"/>
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>

                        <FlexLayout Wrap="Wrap" JustifyContent="Center" AlignItems="Start">
                            <BindableLayout.ItemsSource>
                                <x:Array Type="{x:Type x:String}">
                                    <x:String>excited</x:String>
                                    <x:String>cheery</x:String>
                                    <x:String>i love you</x:String>
                                    <x:String>wow!</x:String>
                                    <x:String>surprise!!</x:String>
                                    <x:String>chitter</x:String>
                                    <x:String>chattering</x:String>
                                    <x:String>whistle</x:String>
                                    <x:String>bleep</x:String>
                                    <x:String>beep</x:String>
                                    <x:String>thinking</x:String>
                                    <x:String>dubious</x:String>
                                    <x:String>worried</x:String>
                                    <x:String>sad</x:String>
                                    <x:String>grump</x:String>
                                    <x:String>scold</x:String>
                                    <x:String>scream!!</x:String>
                                    <x:String>thbt</x:String>
                                    <x:String>descending</x:String>
                                    <x:String>story</x:String>
                                    <x:String>startup</x:String>
                                    <x:String>startup 2</x:String>
                                </x:Array>
                            </BindableLayout.ItemsSource>
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Button Text="{Binding}" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ControllerViewModel}}, Path=PlaySoundCommand}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ControllerViewModel}}, Path=IsConnected}"
                                            Style="{StaticResource SoundButtonStyle}"
                                            SemanticProperties.Description="{Binding StringFormat='Play {0} sound effect'}"/>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- Bottom breathing room -->
                <BoxView HeightRequest="8" Color="Transparent"/>

            </VerticalStackLayout>
        </ScrollView>
    </Grid>

</ContentPage>
